<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>WebCodecs VideoEncoderConfig - Chris Cunningham - W3C/SMPTE Joint Workshop on Professional Media Production on the Web</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="../style.css">
    <link rel="stylesheet" href="../talk-ui.css">
    <link rel="stylesheet" href="https://www.w3.org/2019/09/TPAC-template/fonts/iconmonstr-iconic-font.css">
    <meta name="twitter:site" content="@w3c">
    <meta name="twitter:card" content="player">
    <meta property="og:title" content="WebCodecs VideoEncoderConfig by Chris Cunningham (Google)">
    <meta property="og:description" content="In this talk I&apos;ll present the current state of VideoEncoderConfig dictionary. The idea is to show you what we have so you can tell me what we&apos;re missing.">
    <meta property="og:image" content="thumbnails/chris-cunningham-webcodecs-videoencoderconfig.jpg">
    <meta property="og:video" content="https://iframe.videodelivery.net/0f0004d2a1a01588e0b944b6cb8ad5d4">
    <meta property="twitter:player" content="https://iframe.videodelivery.net/0f0004d2a1a01588e0b944b6cb8ad5d4?defaultTextTrack=en">
    <meta property="twitter:player:width" content="360">
    <meta property="twitter:player:height" content="202">
  </head>
  <body>
    <form id=form><!-- form to request a page in kiosk mode --></form>
    <header id="header" class="header">
      <div id="banner">
        <div>
          <p>
            <a href="https://www.w3.org/"><img alt="W3C" src=
            "../media/w3c_home_nb-v.svg" height="48" width="72"></a>
            <a href="https://www.smpte.org/"><img alt="SMPTE" src=
            "../media/smpte_logo.png" height="48"></a>
          </p>
          <div class="banner-title">
            <h1>
              W3C/SMPTE Joint Workshop on Professional Media Production on the Web
            </h1>
          </div>
          <p class="attribution">
            <span>Timeline photo by <a href="https://unsplash.com/@kineticbear?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText">Jacob Miller</a> on <a href="https://unsplash.com/s/photos/timeline?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText">Unsplash</a></span>
          </p>
          <p>8-19 November 2021; online event</p>
        </div>
      </div>
      <nav class="menu" id="menu">
        <ul>
          <li><a href="../">Call for Participation</a></li>
          <li><a href="../talks.html">Pre-recorded talks</a></li>
          <li><a href="../agenda.html">Live sessions</a></li>
        </ul>
      </nav>
    </header>
    <main id="main" class="main talk">
      <section id="intro">
        <h2>WebCodecs VideoEncoderConfig</h2>

        <p class="talkinfo">
          Presenter: <strong>Chris Cunningham (Google)</strong><br>
          Duration: <strong>9 minutes</strong><br>
          Slides: <a href="slides/chris-cunningham-webcodecs-videoencoderconfig.pdf"><strong>PDF</strong></a>
        </p>

        <p class="buttons">
          <!-- previousStart -->
          <button form="form" type="submit" class="picto im-angle-left" formaction="chris-cunningham-hello-webcodecs.html">
            Previous: Hello WebCodecs
          </button>
          <!-- previousEnd -->
          <a href="../talks.html" class="picto im-data">All talks</a>
          <!-- nextStart -->
          <button form="form" type="submit" formaction="paul-adenot-webcodecs-performance.html">
            Next: Memory access patterns in Web Codecs<span class="picto im-angle-right"></span>
          </button>
          <!-- nextEnd -->
        </p>
      </section>

      <section id="talk">
        <h3 style="display:none">Slides &amp; video</h3>

        <details>
          <summary>Keyboard shortcuts in the video player</summary>
          <ul>
            <li>Play/pause: <kbd>space</kbd>
            </li><li>Increase volume: <kbd>up arrow</kbd>
            </li><li>Decrease volume: <kbd>down arrow</kbd>
            </li><li>Seek forward: <kbd>right arrow</kbd>
            </li><li>Seek backward: <kbd>left arrow</kbd>
            </li><li>Captions on/off: <kbd>C</kbd>
            </li><li>Fullscreen on/off: <kbd>F</kbd>
            </li><li>Mute/unmute: <kbd>M</kbd>
            </li><li>Seek to 0%, 10%… 90%: <kbd>0-9</kbd>
          </li></ul>
        </details>

        <div id="player">
          <script type="application/ld+json">
            {
              "@context": "https://schema.org",
              "@type": "VideoObject",
              "name": "WebCodecs VideoEncoderConfig",
              "description": "In this talk I'll present the current state of VideoEncoderConfig dictionary. The idea is to show you what we have so you can tell me what we're missing.",
              "thumbnailUrl": "thumbnails/chris-cunningham-webcodecs-videoencoderconfig.jpg",
              "duration": "PT9M23S",
              "embedUrl": "https://iframe.videodelivery.net/0f0004d2a1a01588e0b944b6cb8ad5d4",
            }
          </script>

          <iframe id="video" title="WebCodecs VideoEncoderConfig" src="https://iframe.videodelivery.net/0f0004d2a1a01588e0b944b6cb8ad5d4"
            allow="accelerometer; autoplay; encrypted-media; picture-in-picture"
            allowfullscreen="" width="640" height="360" frameborder="0"></iframe>

          
    <div class="related">
      <p>Related conversations on <a href="https://github.com/w3c/media-production-workshop/issues">GitHub</a>:</p>
      <ul>
        <li><a href="https://github.com/w3c/media-production-workshop/issues/59">Advanced use cases for WebCodecs</a> (#59)</li>
      </ul>
    </div>

          <div id="slides" class="fade-in" role="region" aria-live="off" aria-label="Slide container">
            <div id="ts-1"><i-slide src="slides/chris-cunningham-webcodecs-videoencoderconfig.pdf#1" class="slide">Slide 1 of 5</i-slide>
<div>
  <p id="tp-1">Hi, I'm Chris Cunningham. If you missed my earlier WebCodecs primer talk, I encourage you to check that one out first.</p>
  <p id="tp-2">In this talk, I'm going to focus on WebCodecs encoding configuration. The idea is to surface what we have and the reasoning behind it, and have you tell us what to prioritize next. If you look at our configuration structure and compare that to FFmpeg or libvpx, it will immediately be clear that we have lots of knobs we could consider adding.</p>
  <p id="tp-3">Having said that, there are lots of folks who are using WebCodecs and encoding in media production settings and apps. Don't let this talk scare you off.</p>
</div>

</div><div id="ts-2"><i-slide src="slides/chris-cunningham-webcodecs-videoencoderconfig.pdf#2" class="slide">Slide 2 of 5</i-slide>
<div>
  <p id="tp-4">Before I get into the structure, I want to mention the underlying design principle, which is don't constrain features or quality unless the user asks for it.</p>
  <p id="tp-5">For encoding defaults, this might mean we don't constrain quality for the sake of latency. We don't constrain bit rate unless requested. It's VBR by default. We allow B-frames wherever the profile that is configured would allow B-frames.</p>
</div>

</div><div id="ts-3"><i-slide src="slides/chris-cunningham-webcodecs-videoencoderconfig.pdf#3" class="slide">Slide 3 of 5</i-slide>
<div>
  <p id="tp-6">Another thing to mention. When you start encoding, the output callback will also admit a metadata dictionary that contains the video decoding config. This is obviously very important if you want to eventually decode the content you encoded.</p>
  <p id="tp-7">And then it admits that same config anytime the configuration changes, such that, now you need a slightly different configuration to decode what is now being output.</p>
  <p id="tp-8">I mention this because it's useful to describe some of the encoder configuration parameters we're about to get into, in terms of their effect on the emitted decoder config.</p>
</div>

</div><div id="ts-4"><i-slide src="slides/chris-cunningham-webcodecs-videoencoderconfig.pdf#4" class="slide">Slide 4 of 5</i-slide>
<div>
  <p id="tp-9">All right, so here we have just a screenshot from the spec. This is the video encoder config dictionary. At the top, we've got the required parameters. We have codec, which is a codec string, very similar to what you would see in MSE or MediaCapabilities. This is like for H.264, It's av1 dot profile byte, level byte. For VP9, it's VP09 dot profile dot so-on. AV1, AV01. For all codecs that are usable with WebCodecs, you can go to the WebCodecs specification codec registry, and there you can look up the specific codec strings to use for a given codec.</p>
  <p id="tp-10">All right, so next we have width and height, and this is the number of pixels to encode. For video frames, this corresponds to visible width and visible height. For decoder config, this corresponds to display. No. It's again visible width and visible height. If you give us a video frame with a visible width and height that don't match these dimensions, we will actually scale the frame before we encode, and that is originally motivated by RTC use cases, where the camera's open at a high resolution, but then you want the encoder to be able to encode at whatever resolution, because your needs fluctuate with the changes in bit rate and CPU load.</p>
  <p id="tp-11">Okay, so moving on, we are now into optional parameters. There's displayWidth and displayHeight. If not provided, these default to the width and height we just talked about, and generally, that's probably what most people want. Where this is interesting is for things like anamorphic content, where the pixel is actually wider than it is tall when finally rendered. We actually stretch the rendered video just slightly.</p>
  <p id="tp-12">Then we have bitrate. The default is implementer-defined. In Chrome, it's gonna be whatever the underlying codec, like let's say libvpx would use, if you didn't specify a bitrate. That's probably not what you want. If you're using this production, I recommend setting bitrate, in which case I also recommend setting the next knob, which is frame rate. The value here can be rough, like variable frame rate video is common. But the idea is to guide the rate controller. bitrate is bits per second. And so you need to know how many frames per second to know how many bits to give a given frame.</p>
  <p id="tp-13">On our roadmap, we intend to also use frame timestamps to refine this. The minute that you said 30 fps, but we detected it's actually closer to 25 in this one segment of your video, or it's much higher than that in some other segment, we should adjust rate control accordingly. But even then, it's good to provide some sort of baseline upfront, because we won't have any timestamps until some initial frames come in.</p>
  <p id="tp-14">All right, so I'm gonna go out of order just a second and keep talking about bitrate. Next thing I'm gonna say is bitrateMode. This is second from the bottom. This is variable by default, and then the alternative is, of course, constant.</p>
  <p id="tp-15">We aren't super prescriptive about how constant or how variable, like what is the buffer size that we're talking about here? And that reflects the reality that WebCodecs is built on top of many codec implementations, which, themselves, are not super prescriptive or consistent.</p>
  <p id="tp-16">Having said that, some libraries do offer a lot more knobs here, so options to configure the buffer size, the amount of overshoot or undershoot, and we are open to adding those. Let us know if you need them.</p>
  <p id="tp-17">Okay, so now I'm gonna go back up and start with the ones that I missed.</p>
  <p id="tp-18">hardwareAcceleration: so the wording here, it reads like a hint. No preference. Prefer hardware. But browsers have the option to treat this as a hint or to treat it as a requirement, and in Chrome, we treat it as a requirement.</p>
  <p id="tp-19">If you say prefer hardware and we don't have the hardware, or if we can't support some aspect of your configuration in hardware, we will fail to configure, which is fine. It can be actually very useful. You can use the isConfigSupported check in advance to figure out where the support will lie. But you could, let's say if you were really worried about power savings and you had a lot of flexibility in the codec that you were choosing, you could use this to iterate over options on the platform to see, okay, it has accelerated encoding for 264, but maybe not for VP9, so that's the one I'm gonna use because I'm very power-conscious on this platform, whatever. Or maybe you have a WASM fallback that you prefer. You wanna use our hardware encoding, but if it's gonna be software, you prefer to use your software, and that's also totally fine.</p>
  <p id="tp-20">Most folks will probably just take the default of no-preference, and for that default, Chrome will always try to find hardware for the codec and then fall back to software if hardware wasn't available.</p>
  <p id="tp-21">Actually a small caveat on that. It will find hardware above a certain resolution cut-off. Below a certain resolution point, using a hardware-accelerated codec is not desirable. It actually can be a little bit more in startup costs and no savings in power, in which case we use software.</p>
  <p id="tp-22">All right, scalabilityMode. This is a string that identifies patterns of layering for scalable codecs. For media production, you probably don't care about this. You probably just want one layer. This is probably more interesting for RTC folks. The linked spec here, WebRTC SVC, has lots more details in the diagrams and patterns of scalability layering. And then finally latencyMode. This is, by default, quality", where the other option is, what is it? realtime". Most folks in this group probably want quality, but it's interesting to talk about realtime, because obviously very useful for realtime scenarios. But there's an interaction with some of the knobs above, which is that, in realtime, we strive to get the frames out and achieve the bit rate target and the frame rate target more strictly. We'll actually use frame rate as kind of a deadline. If we can't encode a frame in realtime mode and maintain the frame rate, in terms of our output, then we will drop frames, where encoders support that.</p>
</div>

</div><div id="ts-5"><i-slide src="slides/chris-cunningham-webcodecs-videoencoderconfig.pdf#5" class="slide">Slide 5 of 5</i-slide>
<div>
  <p id="tp-23">Okay, so those are our different knobs that we have so far. This is a link to our GitHub. Please let us know what you need. We like to prioritize things by impact. If you can tell us why you need it, what is it you plan to do with it, how is it gonna be a better experience for your users, if you come to our GitHub and you already see an issue filed for the knob that you want, pile on. Again, that's impact, to say, hey, there's five apps that want this knob. Okay, we'll pay attention to that, sure.</p>
  <p id="tp-24">Yeah, that's it. Thank you so much for watching.</p>
</div>

</div>
          </div>
        </div>
      </section>

      <section id="extrabuttons">
        <p class="buttons">
          <!-- previousStart -->
          <button form="form" id="prevtalk" type="submit" formaction="chris-cunningham-hello-webcodecs.html" class="picto im-angle-left">Previous: Hello WebCodecs</button>
          <!-- previousEnd -->
          <a id="alltalks" href="../talks.html" class="picto im-data">All talks</a>
          <!-- nextStart -->
          <button form="form" id="nexttalk" type="submit" formaction="paul-adenot-webcodecs-performance.html">Next: Memory access patterns in Web Codecs<span class="picto im-angle-right"></span></button>
          <!-- nextEnd -->
        </p>
      </section>

      <section id="sponsors">
        <h2>
          Workshop sponsor
        </h2>
        <p><a href="https://www.adobe.com/"><img src="../media/adobe.png" alt="Adobe" width="70"></a></p>
        <p class="small">Interested in sponsoring the workshop?<br/>Please check the <a href="sponsors.html">sponsorship package</a>.</p>
      </section>
    </main>
    <footer class="footer" id="footer">
      <p>
        W3C is proud to be an open and inclusive organization, focused on
        productive discussions and actions. Our <a href=
        "https://www.w3.org/Consortium/cepc/">Code of Ethics and Professional
        Conduct</a> ensures that all voices can be heard.
      </p>
      <p>Questions? Contact François Daoust
        &lt;<a href="mailto:fd@w3.org">fd@w3.org</a>&gt;.
      </p>
      <p>
        Suggestions for improving this workshop page, such as fixing typos or
        adding specific topics, can be made by opening a <a href=
        "https://github.com/w3c/media-production-workshop/">pull request on
        GitHub</a>, or by emailing François Daoust
        &lt;<a href="mailto:fd@w3.org">fd@w3.org</a>&gt;.
      </p>
    </footer>
    <script src="../script.js"></script>
    <script>
      let captions = [
  {
    "language": "en",
    "label": "English",
    "src": "captions/chris-cunningham-webcodecs-videoencoderconfig.vtt",
    "mode": "hidden",
    "cues": [],
    "activeCues": [
      {
        "text": ""
      }
    ]
  }
];
    </script>
    <script src="https://www.w3.org/2019/09/TPAC-template/parser.js"></script>
    <script src="https://embed.videodelivery.net/embed/sdk.latest.js"></script>
    <script src="../talk-sync.js"></script>
    <script src="https://w3c.github.io/i-slide/i-slide.js" type="module"></script>
  </body>
</html>
